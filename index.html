<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>btw13.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://assets.pudo.org/spiegel/fonts/fonts.css" />
    <link rel="stylesheet" type="text/css" href="css/bigboard.css" />
    <link rel="shortcut icon" href="http://assets.pudo.org/img/favicon.ico">

  </head>
  <body>
    <div id="results-warning">
      Alle dargestellten Daten sind Testdaten. Das Ergebnis der Bundestagswahl wird traditionsgemäß erst 
      nach deren Durchführung verkündet.
    </div>

    <div id="airlock">
      <div class="container loading">
        <div class="row">
          <div class="col-md-12">
            Ergebnisse werden geladen und tabuliert...
          </div>
        </div>
      </div>
    </div>

    <script id="bigboard-template" type="text/x-handlebars-template">
      <header class="container">
        <div class="row">
          <div class="col-xs-10">
            <div class="election-name">{{summary.election}}</div>
          </div>
          <div class="col-xs-2">
            <div class="mark-temporary">{{summary.result}}</div>
          </div>
        <div>
      </header>

      <div class="container">
        {{#parties}}
          <div class="row result {{classes}}">
            <div class="col-xs-2 party-name fg-{{slug}} light">
              {{name}}
            </div>
            <div class="col-xs-2 numeric">
              {{percentage}}%
            </div>
            <div class="col-xs-1">
              <span class="trend {{percentage_trend}}">{{percentage_diff_text}}</span>
            </div>
            <div class="col-xs-2 numeric">
              {{direct_mandates}} <span class="legend">Kreise</span>
            </div>
            <div class="col-xs-1">
              <span class="trend {{direct_mandates_trend}}">{{direct_mandates_diff_text}}</span>
            </div>
            <div class="col-xs-2 numeric">
              {{total_seats}}
              <span class="legend">Sitze</span>
            </div>
            <div class="col-xs-1">
              <span class="trend {{total_seats_trend}}">{{total_seats_diff_text}}</span>
            </div>
            <!--div class="col-xs-2 numeric">
              {{secondary_votes}}
            </div-->
          </div>
        {{/parties}}
      </div>

      <!--div class="container">
        <div class="row states-list">
          <ul>
            {{#states}}
              <li><a href="#state-{{id}}">{{code}}</a></li>
            {{/states}}
          </ul>
        </div>
      </div>

      <div class="container">
        {{#states}}
          <div class="row">
            <a name="state-{{id}}"></a>
            <h2>{{code}} <small>{{label}}</small></h2>
          </div>
        {{/states}}
      </div-->

      <footer class="container">
        <div class="row">
          <div class="col-md-12">
            <a href="https://github.com/pudo/btw13.js">btw13.js</a>: Auswertung auf Basis der Daten des Bundeswahlleiters.
          </div>
        <div>
      </footer>
    </script>
    
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js" charset="utf-8"></script>

    <script src="btw13.min.js" charset="utf-8"></script>
    <script>
      $(function() {
        STATES = {
            1: {seats: 22, code: 'SH'},
            2: {seats: 13, code: 'HH'},
            3: {seats: 59, code: 'NI'},
            4: {seats: 5, code: 'BR'},
            5: {seats: 128, code: 'NW'},
            6: {seats: 43, code: 'HE'},
            7: {seats: 30, code: 'RP'},
            8: {seats: 76, code: 'BW'},
            9: {seats: 92, code: 'BY'},
            10: {seats: 7, code: 'SL'},
            11: {seats: 24, code: 'BE'},
            12: {seats: 19, code: 'BB'},
            13: {seats: 13, code: 'MV'},
            14: {seats: 32, code: 'SN'},
            15: {seats: 15, code: 'ST'},
            16: {seats: 17, code: 'TH'}
        };

        var template = Handlebars.compile($('#bigboard-template').html());

        function numericTrend(n) {
          if (n==0) return 'neutral';
          if (n>0) return 'increase';
          return 'decrease';
        }

        function trendText(n) {
          if (parseFloat(n)==0) return '';
          if (parseFloat(n)>0) return '+' + n;
          return '' + n; 
        }

        function partySlug(name) {
          name = name.toLowerCase().replace(/ü/g, 'u').replace(/ä/g, 'a')
          return name.replace(/ö/g, 'o').replace(/[^a-zA-Z0-9]/g, '');
        }

        function summarizeCduCsu(tab) {
          

          var cdu = tab.parties.CDU,
              csu = tab.parties.CSU,
              cdu_csu = {
                secondary_votes: cdu.secondary_votes + csu.secondary_votes,
                total_seats: cdu.total_seats + csu.total_seats,
                direct_mandates: cdu.direct_mandates + csu.direct_mandates,
              }; 
          //cdu_cdu = t
          delete tab.parties.CDU;
          delete tab.parties.CSU;
          tab.parties['CDU/CSU'] = cdu_csu;
        }

        function handleData(data) {
          var results = Bundestagswahl.parseResults(data),
              tabulator = new Bundestagswahl.Tabulator(results, results.result_type),
              tab = tabulator.tabulate(),
              previous_tabulator = new Bundestagswahl.Tabulator(results, 'Vorperiode'),
              previous_tab = previous_tabulator.tabulate();

          summarizeCduCsu(tab);
          summarizeCduCsu(previous_tab);
          //console.log(tab.parties);

          // Format party results.
          tab.parties = _.map(tab.parties, function(v, k) {
            var pv = previous_tab.parties[k];
            v.name = k;
            v.slug = partySlug(k);

            v.percentage_num = (v.secondary_votes / tab.summary.valid_votes*100)
            v.prev_percentage = (pv.secondary_votes / previous_tab.summary.valid_votes*100)
            v.percentage = v.percentage_num.toFixed(1);

            v.percentage_diff = v.percentage_num - v.prev_percentage;
            v.percentage_trend = numericTrend(v.percentage_diff);
            v.percentage_diff_text = trendText(v.percentage_diff.toFixed(1));

            v.total_seats_diff = v.total_seats - pv.total_seats;
            v.total_seats_trend = numericTrend(v.total_seats_diff);
            v.total_seats_diff_text = trendText(v.total_seats_diff);

            v.direct_mandates_diff = v.direct_mandates - pv.direct_mandates;
            v.direct_mandates_trend = numericTrend(v.direct_mandates_diff);
            v.direct_mandates_diff_text = trendText(v.direct_mandates_diff);

            //console.log(v);
            v.classes = [];
            if (v.total_seats > 0) v.classes.push('elected');
            if (v.is_fraktion > 0) v.classes.push('faction');
            v.classes = v.classes.join(' ');
            return v;
          });
          tab.parties = _.filter(tab.parties, function(e) {
            return e.percentage_num > 0.4;
          });
          tab.parties = _.sortBy(tab.parties, function(e) {
            return e.percentage_num * -1;
          });

          tab.states = _.map(tab.states, function(v, k) {
            v.id = k;
            v.code = STATES[k].code;
            v.seats = STATES[k].seats;
            return v;
          });
          tab.states = _.sortBy(tab.states, function(e) {
            return e.code;
          });
          //console.log(tab);
          $('#airlock').html(template(tab));
        }

        $.ajax({
          url: 'data/kerg.csv',
          dataType: 'text',
          success: handleData,
          mimeType: 'text/plain; charset=iso-8859-1'
        });
        
      });
    </script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-34039573-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
